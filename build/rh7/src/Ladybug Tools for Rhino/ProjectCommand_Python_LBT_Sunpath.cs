using System;

using Rhino.Commands;

namespace RhinoCodePlatform.Rhino3D.Projects.Plugin
{
  [CommandStyle(Rhino.Commands.Style.ScriptRunner)]
  public class ProjectCommand_Python_LBT_Sunpath  : Command
  {
    Rhino.Runtime.PythonScript _script;
    Rhino.Runtime.PythonCompiledCode _compiledCode;

    public Guid CommandId { get; } = new Guid("0566725e-a8ae-4419-8d94-4d0c6910c256");

    public override string EnglishName => "LBT_Sunpath";

    protected override Rhino.Commands.Result RunCommand(Rhino.RhinoDoc doc, Rhino.Commands.RunMode mode)
    {
      if (_compiledCode is null)
      {
        ProjectLibs.InitPythonLibraries();

        _script = Rhino.Runtime.PythonScript.Create();
        _compiledCode = _script.Compile(
            ProjectPlugin.DecryptString("IyEgcHl0aG9uIDINCmltcG9ydCBvcw0KaW1wb3J0IG1hdGgNCg0KdHJ5Og0KICAgIGZyb20gbGFkeWJ1Z19nZW9tZXRyeS5nZW9tZXRyeTJkIGltcG9ydCBQb2ludDJEDQogICAgZnJvbSBsYWR5YnVnX2dlb21ldHJ5Lmdlb21ldHJ5M2QgaW1wb3J0IFBvaW50M0QsIFZlY3RvcjNEDQpleGNlcHQgSW1wb3J0RXJyb3IgYXMgZToNCiAgICByYWlzZSBJbXBvcnRFcnJvcignXG5GYWlsZWQgdG8gaW1wb3J0IGxhZHlidWdfZ2VvbWV0cnk6XG5cdHt9Jy5mb3JtYXQoZSkpDQoNCnRyeToNCiAgICBmcm9tIGxhZHlidWcuZXB3IGltcG9ydCBFUFcNCiAgICBmcm9tIGxhZHlidWcuc3VucGF0aCBpbXBvcnQgU3VucGF0aA0KZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6DQogICAgcmFpc2UgSW1wb3J0RXJyb3IoJ1xuRmFpbGVkIHRvIGltcG9ydCBsYWR5YnVnOlxuXHR7fScuZm9ybWF0KGUpKQ0KDQp0cnk6DQogICAgZnJvbSBsYWR5YnVnX3JoaW5vLmNvbmZpZyBpbXBvcnQgY29udmVyc2lvbl90b19tZXRlcnMNCiAgICBmcm9tIGxhZHlidWdfcmhpbm8uYmFrZW9iamVjdHMgaW1wb3J0IGJha2VfdmlzdWFsaXphdGlvbl9zZXQNCmV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOg0KICAgIHJhaXNlIEltcG9ydEVycm9yKCdcbkZhaWxlZCB0byBpbXBvcnQgbGFkeWJ1Z19yaGlubzpcblx0e30nLmZvcm1hdChlKSkNCg0KaW1wb3J0IFJoaW5vDQppbXBvcnQgcmhpbm9zY3JpcHRzeW50YXggYXMgcnMNCg0KDQpkZWYgcnVuX3N1bnBhdGhfY29tbWFuZCgpOg0KICAgICMgZ2V0IHRoZSBFUFcNCiAgICBnZXB3ID0gUmhpbm8uSW5wdXQuQ3VzdG9tLkdldFN0cmluZygpDQogICAgZ2Vwdy5TZXRDb21tYW5kUHJvbXB0KCdTZWxlY3QgYW4gRVBXIGZpbGUgcGF0aCcpDQogICAgDQogICAgIyBhZGQgYW4gb3B0aW9uIHRvIHNldCB0aGUgbm9ydGgNCiAgICBub3J0aF9vcHRpb24gPSBSaGluby5JbnB1dC5DdXN0b20uT3B0aW9uRG91YmxlKDAsIDAsIDM2MCkNCiAgICBnZXB3LkFkZE9wdGlvbkRvdWJsZSgnTm9ydGgnLCBub3J0aF9vcHRpb24pDQogICAgd2hpbGUgVHJ1ZToNCiAgICAgICAgIyBwZXJmb3JtIHRoZSBnZXQgb3BlcmF0aW9uLiBUaGlzIHdpbGwgcHJvbXB0IHRoZSB1c2VyIHRvDQogICAgICAgICMgaW5wdXQgYSBwb2ludCwgYnV0IGFsc28gYWxsb3cgZm9yIGNvbW1hbmQgbGluZSBvcHRpb25zDQogICAgICAgICMgZGVmaW5lZCBhYm92ZQ0KICAgICAgICBnZXRfZXB3ID0gZ2Vwdy5HZXQoKQ0KICAgICAgICBpZiBnZXRfZXB3ID09IFJoaW5vLklucHV0LkdldFJlc3VsdC5TdHJpbmc6DQogICAgICAgICAgICBlcHdfcGF0aCA9IGdlcHcuU3RyaW5nUmVzdWx0KCkNCiAgICAgICAgICAgIG5vcnRoXyA9IG5vcnRoX29wdGlvbi5DdXJyZW50VmFsdWUNCiAgICAgICAgZWxpZiBnZXRfZXB3ID09IFJoaW5vLklucHV0LkdldFJlc3VsdC5PcHRpb246DQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICBicmVhaw0KDQoNCiAgICBpZiBub3QgZXB3X3BhdGg6DQogICAgICAgIHJldHVybg0KICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShlcHdfcGF0aCk6DQogICAgICAgIHByaW50KCdTZWxlY3RlZCBFUFcgZmlsZSBhdCBkb2VzIG5vdCBleGlzdCBhdDoge30nLmZvcm1hdChlcHdfcGF0aCkpDQogICAgICAgIHJldHVybg0KDQogICAgIyBwcm9jZXNzIGFsbCBvZiB0aGUgZ2xvYmFsIGlucHV0cyBmb3IgdGhlIHN1bnBhdGgNCiAgICBjZW50ZXJfcHQsIGNlbnRlcl9wdDNkID0gUG9pbnQyRCgpLCBQb2ludDNEKCkNCiAgICB6ID0gMA0KICAgIF9zY2FsZV8gPSAxDQogICAgcmFkaXVzID0gKDEwMCAqIF9zY2FsZV8pIC8gY29udmVyc2lvbl90b19tZXRlcnMoKQ0KICAgIHNvbGFyX3RpbWVfID0gRmFsc2UNCiAgICBkYWlseV8gPSBGYWxzZQ0KICAgIHByb2plY3Rpb25fID0gTm9uZQ0KICAgIGRsX3NhdmluZ18gPSBOb25lDQogICAgbF9wYXIgPSBOb25lDQogICAgaG95c18gPSBbXQ0KICAgIGRhdGFfID0gW10NCg0KICAgICMgZ2V0IHRoZSBsb2NhdGlvbiBmcm9tIHRoZSBFUFcNCiAgICBlcHdfb2JqID0gRVBXKGVwd19wYXRoKQ0KICAgIF9sb2NhdGlvbiA9IGVwd19vYmoubG9jYXRpb24NCg0KICAgICMgbWFrZSB0aGUgc3VucGF0aA0KICAgIHNwID0gU3VucGF0aC5mcm9tX2xvY2F0aW9uKF9sb2NhdGlvbiwgbm9ydGhfLCBkbF9zYXZpbmdfKQ0KICAgIHZpc19zZXRfYXJncyA9IFtob3lzXywgZGF0YV8sIGxfcGFyLCByYWRpdXMsIGNlbnRlcl9wdDNkLCBzb2xhcl90aW1lXywgZGFpbHlfLCBwcm9qZWN0aW9uX10NCiAgICB2aXNfc2V0ID0gc3AudG9fdmlzX3NldCgqdmlzX3NldF9hcmdzKQ0KICAgIGJha2VfdmlzdWFsaXphdGlvbl9zZXQodmlzX3NldCkNCg0KDQpydW5fc3VucGF0aF9jb21tYW5kKCkNCg==")
          );
      }

      if (_compiledCode is null)
      {
        Rhino.RhinoApp.WriteLine("The script code for {0} could not be retrieved or compiled.", EnglishName);
        return Rhino.Commands.Result.Failure;
      }

      _script.ScriptContextDoc = doc;
      _script.SetVariable("__name__", "__main__");

      _compiledCode.Execute(_script);

      return Rhino.Commands.Result.Success;
    }
  }
}
